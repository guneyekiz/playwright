name: CI and Deploy to GitHub Pages

on:  
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
     contents: write
     deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci 

      - name: Install Playwright
        run: npm install playwright

      - name: Install browsers
        run: npx playwright install

      - name: Run Playwright tests
        run: npx playwright test --reporter=html
        continue-on-error: true

      - name: Get current date
        id: current-date
        run: echo "::set-output name=date::$(date +'%Y/%m/%d')"

      - name: Checkout gh-pages branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0  # Fetch all history for .GitInfo and .Lastmod
        continue-on-error: true

      - name: Create gh-pages branch if it doesn't exist
        if: steps.checkout.outcome == 'failure'
        run: |
          cd gh-pages
          git checkout --orphan gh-pages
          git rm -rf .
          echo "Repository created on $(date)" > index.html
          git add index.html
          git commit -m "Initial gh-pages branch"
          git push origin gh-pages

      - name: Configure Git
        run: |
          cd gh-pages
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Create new report directory
        run: mkdir -p gh-pages/${{ steps.current-date.outputs.date }}/playwright-report

      - name: Copy Playwright report to new directory
        run: cp -r playwright-report/* gh-pages/${{ steps.current-date.outputs.date }}/playwright-report/

      - name: Commit and Push Playwright report to gh-pages
        run: |
          cd gh-pages
          git add .
          git commit -m "Deploy Playwright report for ${{ steps.current-date.outputs.date }}"
          git push -fu origin gh-pages

      - name: Output Playwright report URL
        run: |
          echo "Playwright report URL: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/${{ steps.current-date.outputs.date }}/playwright-report/"
